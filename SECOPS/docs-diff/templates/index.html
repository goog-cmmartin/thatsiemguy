<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Diff Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; }
        .main-container { max-width: 85%; margin: 2rem auto; }
        .report-header { padding-bottom: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #dee2e6; }
        .card { border: none; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1); }
        .markdown-body h3 { border-bottom: 1px solid #eee; padding-bottom: .5rem; margin-top: 1.5rem; font-size: 1.4rem; }
        .markdown-body h3:first-child { margin-top: 0; }
        .chart-container { position: relative; height: 180px; width: 100%; } /* Reduced height */
        mark { background-color: #ffdd57; padding: 0.1em; }
        /* Style for card title links */
        .card-title a {
            text-decoration: none; /* Remove underline by default */
        }
        .card-title a:hover {
            text-decoration: underline; /* Add underline on hover */
        }
        .product-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
        }
        .subtle-hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0)); /* Darker */
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }
        .copy-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: .25rem .5rem;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .2rem;
        }
        .google-logo {
            height: 32px; /* Adjust size as needed */
            vertical-align: middle;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <header class="report-header">
            <div class="row align-items-center">
                <div class="col-md-6 d-flex align-items-center">
                    <img src="/static/Google__G__logo.svg" alt="Google G Logo" class="google-logo">
                    <h1>Doc Diff Dashboard</h1>
                </div>
                <div class="col-md-6 text-md-end">
                    <span id="last-updated" class="text-muted"></span>
                </div>
            </div>
            <div class="row mt-3">
                <div id="filter-toolbar" class="col-md-12 d-flex align-items-center">
                    <input type="search" id="search-input" class="form-control me-2" placeholder="Search summaries...">
                    <select id="product-filter" class="form-select me-2">
                        <option value="">All Products</option>
                    </select>
                    <select id="change-type-filter" class="form-select me-2">
                        <option value="">All Changes</option>
                        <option value="new">New</option>
                        <option value="updated">Updated</option>
                    </select>
                    <select id="sort-order" class="form-select me-2">
                        <option value="DESC">Newest First</option>
                        <option value="ASC">Oldest First</option>
                    </select>
                    <input type="date" id="start-date" class="form-control me-2">
                    <input type="date" id="end-date" class="form-control me-2">
                </div>
            </div>
        </header>

        <div id="graph-container" class="accordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGraph">
                        Weekly Activity Summary
                    </button>
                </h2>
                <div id="collapseGraph" class="accordion-collapse collapse show">
                    <div class="accordion-body">
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-content" class="mt-4">
            <!-- Reports will be dynamically loaded here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const productFilter = document.getElementById('product-filter');
            const changeTypeFilter = document.getElementById('change-type-filter');
            const sortOrderFilter = document.getElementById('sort-order');
            const searchInput = document.getElementById('search-input');
            const filterToolbar = document.getElementById('filter-toolbar');
            const graphContainer = document.getElementById('graph-container');
            const reportContent = document.getElementById('report-content');
            const lastUpdatedSpan = document.getElementById('last-updated');

            let activityChart;
            let docSources = {{ doc_sources | tojson }};
            let productIcons = {{ product_icons | tojson }};

            function getShortenedUrl(fullUrl) {
                for (const tag in docSources) {
                    if (fullUrl.startsWith(docSources[tag])) {
                        return fullUrl.substring(docSources[tag].length);
                    }
                }
                return fullUrl;
            }
            
            function humanizeUrl(slug) {
                if (!slug) return '';
                return slug
                    .split('/')
                    .map(part => part.replace(/-/g, ' '))
                    .map(part => part.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '))
                    .join(': ');
            }

            // Utility function to get the ordinal suffix for a number
            function getOrdinalSuffix(day) {
                if (day > 3 && day < 21) return 'th';
                switch (day % 10) {
                    case 1: return 'st';
                    case 2: return 'nd';
                    case 3: return 'rd';
                    default: return 'th';
                }
            }

            // Function to format the date
            function formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                const day = date.getDate();
                const month = date.toLocaleString('default', { month: 'long' });
                const year = date.getFullYear();
                return `${day}${getOrdinalSuffix(day)} ${month}, ${year}`;
            }

            // Function to encode a string for use in an HTML attribute
            function encodeHTML(str) {
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            }

            // Function to copy text to clipboard
            async function copyToClipboard(button, textToCopy, feedbackText) {
                try {
                    await navigator.clipboard.writeText(textToCopy);
                    const originalHtml = button.innerHTML;
                    button.innerHTML = feedbackText;
                    setTimeout(() => {
                        button.innerHTML = originalHtml;
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy: ', err);
                }
            }

            function renderReports(reports) {
                reportContent.innerHTML = '';
                if (reports.length === 0) {
                    reportContent.innerHTML = '<p class="text-center">No reports found for the selected criteria.</p>';
                    return;
                }

                let currentScrapeDate = null;
                reports.forEach(report => {
                    if (report.scrape_date !== currentScrapeDate) {
                        currentScrapeDate = report.scrape_date;
                        reportContent.innerHTML += `<h2 class="mt-4">${formatDate(currentScrapeDate)}</h2>`;
                    }
                    const badgeClass = report.change_type === 'new' ? 'bg-success' : 'bg-primary';
                    const summaryForDisplay = report.summary ? marked.parse(report.summary) : '';
                    const summaryForCopy = report.plain_summary || '';
                    const shortUrl = getShortenedUrl(report.url);
                    const displayUrl = humanizeUrl(shortUrl);
                    const iconPath = productIcons[report.source_tag];
                    const iconHtml = iconPath ? `<img src="${iconPath}" class="product-icon">` : '';

                    reportContent.innerHTML += `
                        <div class="card mt-3">
                            <div class="card-body" style="position: relative;">
                                <h5 class="card-title d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        ${iconHtml}
                                        <a href="${report.url}" target="_blank">${displayUrl}</a>
                                    </div>
                                    <div>
                                        <span class="badge bg-secondary text-uppercase">${report.source_tag}</span>
                                        <span class="badge ${badgeClass} text-uppercase">${report.change_type}</span>
                                    </div>
                                </h5>
                                <hr class="subtle-hr">
                                <div class="card-text">${summaryForDisplay}</div>
                                <button class="btn btn-outline-secondary copy-button" data-summary="${encodeHTML(summaryForCopy)}" title="Copy Summary">ðŸ“‹</button>
                                <button class="btn btn-outline-secondary copy-button" style="right: 50px;" data-log-id="${report.log_id}" title="Copy Link">ðŸ”—</button>
                            </div>
                        </div>
                    `;
                });

                // Attach event listeners after rendering all reports
                document.querySelectorAll('.copy-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        if (event.target.dataset.summary) {
                            copyToClipboard(event.target, event.target.dataset.summary, 'Copied! &#x2714;');
                        } else if (event.target.dataset.logId) {
                            const permalink = `${window.location.origin}${window.location.pathname}?log_id=${event.target.dataset.logId}`;
                            copyToClipboard(event.target, permalink, 'Link Copied! &#x2714;');
                        }
                    });
                });
            }
            
            async function fetchReportsAndChart(logId = null) {
                const params = new URLSearchParams();

                if (logId) {
                    params.append('log_id', logId);
                    filterToolbar.style.display = 'none';
                    graphContainer.style.display = 'none';
                } else {
                    const startDate = startDateInput.value;
                    const endDate = endDateInput.value;
                    const product = productFilter.value;
                    const changeType = changeTypeFilter.value;
                    const sortOrder = sortOrderFilter.value;
                    const searchTerm = searchInput.value;
                    
                    if (startDate) params.append('start_date', startDate);
                    if (endDate) params.append('end_date', endDate);
                    if (product) params.append('product', product);
                    if (changeType) params.append('change_type', changeType);
                    if (sortOrder) params.append('sort', sortOrder);
                    if (searchTerm) params.append('search', searchTerm);
                }

                const reportUrl = '/api/reports?' + params.toString();
                
                try {
                    const reportResponse = await fetch(reportUrl);
                    const reportData = await reportResponse.json();
                    renderReports(reportData);

                    if (!logId) {
                        const activityUrl = '/api/activity?' + params.toString();
                        const activityResponse = await fetch(activityUrl);
                        const chartData = await activityResponse.json();
                        renderChart(chartData);
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    reportContent.innerHTML = '<p class="text-danger text-center">Failed to load data.</p>';
                }
            }

            async function fetchProducts() {
                try {
                    const response = await fetch('/api/products');
                    const products = await response.json();
                    products.forEach(product => {
                        const option = document.createElement('option');
                        option.value = product;
                        option.textContent = product;
                        productFilter.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error fetching products:', error);
                }
            }

            function renderChart(chartData) {
                const ctx = document.getElementById('activityChart').getContext('2d');
                if (activityChart) {
                    activityChart.destroy();
                }
                activityChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true, // Enable stacking for x-axis
                                grid: { display: false }
                            },
                            y: {
                                stacked: true, // Enable stacking for y-axis
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        },
                        onClick: (e) => {
                            const points = activityChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, true);
                            if (points.length) {
                                const firstPoint = points[0];
                                const dateLabel = activityChart.data.labels[firstPoint.index];
                                startDateInput.value = dateLabel;
                                endDateInput.value = dateLabel;
                                fetchReportsAndChart();
                            }
                        }
                    }
                });
            }

            async function fetchLastUpdated() {
                try {
                    const response = await fetch('/api/last_updated');
                    const data = await response.json();
                    if (data.last_updated) {
                        lastUpdatedSpan.textContent = `Last Updated: ${formatDate(data.last_updated)}`;
                    }
                } catch (error) {
                    console.error('Error fetching last updated timestamp:', error);
                }
            }
            
            async function initializePage() {
                const urlParams = new URLSearchParams(window.location.search);
                const logId = urlParams.get('log_id');

                if (logId) {
                    await fetchReportsAndChart(logId);
                } else {
                    await fetchProducts();
                    const initialProduct = urlParams.get('product');
                    if (initialProduct) {
                        productFilter.value = initialProduct;
                    }

                    const today = new Date();
                    const todayISO = today.toISOString().split('T')[0];
                    endDateInput.value = todayISO;

                    const threeDaysAgo = new Date(today);
                    threeDaysAgo.setDate(today.getDate() - 3);
                    startDateInput.value = threeDaysAgo.toISOString().split('T')[0];
                    
                    await fetchReportsAndChart();
                }
                fetchLastUpdated();
            }

            filterToolbar.addEventListener('input', () => fetchReportsAndChart());
            
            initializePage();
        });
    </script>
</body>
</html>