<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecOps SDK: MTTx Report</title>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.3.0/flowbite.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
        }
        .dark .card {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        .tab-btn {
            cursor: pointer;
            transition: color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .tab-active { color: #2563eb; border-color: #2563eb; }
        .dark .tab-active { color: #3b82f6; border-color: #3b82f6; }
        .tab-inactive { color: #6b7280; border-color: transparent; }
        .tab-inactive:hover { color: #111827; border-color: #d1d5db; }
        .dark .tab-inactive { color: #9ca3af; }
        .dark .tab-inactive:hover { color: #f9fafb; border-color: #4b5563; }
        .status-badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 0.75em;
            font-weight: 500;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
        }
        .filter-pill {
            display: inline-flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #3730a3;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .dark .filter-pill {
            background-color: #374151;
            color: #e5e7eb;
        }
        .filter-pill button {
            margin-left: 0.5rem;
            color: #4f46e5;
            background: none;
            border: none;
            cursor: pointer;
        }
        .dark .filter-pill button {
            color: #818cf8;
        }
        .tag-chip {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 0.375rem;
            margin: 0.125rem;
        }
        .filter-options-list.collapsed > label:nth-child(n+11) {
            display: none;
        }        
    </style>
    <script>
        // On page load or when changing themes, best to add inline in `head` to avoid FOUC
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-300">

    <header class="bg-white shadow-sm border-b border-gray-200 dark:bg-gray-800 dark:border-gray-700">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">SecOps SDK: MTTx Report</h1>
            <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
                <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- Main Tab Navigation -->
        <div class="border-b border-gray-200 dark:border-gray-700">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button data-target="tenants-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">Tenants</button>
                <button data-target="configs-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">Configurations</button>
                <button data-target="analysis-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">Ad-hoc Analysis</button>
                <button data-target="results-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">MTTx Results</button>
                <button data-target="scheduler-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">Scheduler</button>
                <button data-target="signal-panel" class="tab-btn py-4 px-1 border-b-2 font-medium text-base">Signal to Noise</button>
            </nav>
        </div>

        <div class="pt-8">
            <!-- Scheduler Panel -->
            <div id="scheduler-panel" class="main-tab-panel hidden">
                <p class="mb-6 text-gray-600 dark:text-gray-400">Configure scheduled CSV based exports per Tenant.</p>
                <div class="space-y-8">
                    <div class="card p-6">
                        <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                            <h2 class="text-2xl font-bold dark:text-white">Scheduler Configuration</h2>
                            <button id="create-schedule-btn" type="button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Create New Schedule</button>
                        </div>
                        <div>
                            <label for="scheduler-tenant-select" class="block font-semibold mb-1 dark:text-gray-300">Select Tenant to Configure Schedules</label>
                            <select id="scheduler-tenant-select" class="w-full p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></select>
                        </div>
                        <div id="scheduler-content" class="mt-4 hidden">
                            <!-- Schedules table will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Schedule Modal -->
            <div id="schedule-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                <div class="relative p-4 w-full max-w-4xl max-h-full">
                    <!-- Modal content -->
                    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                        <!-- Modal header -->
                        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                            <h3 id="schedule-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">Create New Schedule</h3>
                            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="schedule-modal">
                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                                <span class="sr-only">Close modal</span>
                            </button>
                        </div>
                        <!-- Modal body -->
                        <div class="p-4 md:p-5">
                            <form id="schedule-form" class="space-y-4"></form>
                            <div class="border-t mt-6 pt-4 dark:border-gray-600">
                                <h4 class="text-lg font-semibold mb-2 dark:text-white">Output Destinations</h4>
                                <div id="destinations-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tenants Panel -->
            <div id="tenants-panel" class="main-tab-panel">
                <p id="tenant-instructions" class="mb-6 text-gray-600 dark:text-gray-400">Start here by adding an instance of Google SecOps. This application GOOGLE_APPLICATION_CREDENTIALS and so the user running the `main.py` will require at a minimum `dashboardQueries.execute`, `dashboards.create`, and `dataTables.create` for SIEM integration, and a SOAR API key with Admin permissions.</p>
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                        <h2 class="text-2xl font-bold dark:text-white">Configured Tenants</h2>
                        <button id="add-tenant-btn" type="button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Add New Tenant</button>
                    </div>
                    <ul id="tenant-list" class="space-y-3"></ul>
                </div>
            </div>

            <!-- Tenant Modal -->
            <div id="tenant-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                <div class="relative p-4 w-full max-w-2xl max-h-full">
                    <!-- Modal content -->
                    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                        <!-- Modal header -->
                        <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                            <h3 id="tenant-modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">Add New Tenant</h3>
                            <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="tenant-modal">
                                <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                                <span class="sr-only">Close modal</span>
                            </button>
                        </div>
                        <!-- Modal body -->
                        <div class="p-4 md:p-5">
                            <form id="add-tenant-form" class="space-y-4">
                                <input type="hidden" id="tenant-id">
                                <div>
                                    <label for="tenant-name" class="block font-semibold dark:text-gray-300">Tenant Name</label>
                                    <input type="text" id="tenant-name" placeholder="e.g., Primary Production" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                <div>
                                    <label for="tenant-guid" class="block font-semibold dark:text-gray-300">Customer ID (GUID)</label>
                                    <input type="text" id="tenant-guid" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                <div>
                                    <label for="tenant-gcp-project" class="block font-semibold dark:text-gray-300">GCP Project ID</label>
                                    <input type="text" id="tenant-gcp-project" placeholder="your-gcp-project-id" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                 <div>
                                    <label for="tenant-region" class="block font-semibold dark:text-gray-300">Region</label>
                                    <input type="text" id="tenant-region" placeholder="e.g., us-central1" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                <div>
                                    <label for="base-url" class="block font-semibold dark:text-gray-300">Base URL</label>
                                    <input type="url" id="base-url" placeholder="https://<your-secops-instance>" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                </div>
                                <div class="border-t pt-4 dark:border-gray-600">
                                    <h3 class="font-semibold text-gray-600 mb-2 dark:text-gray-400">SOAR Configuration</h3>
                                    <div>
                                        <label for="soar-url" class="block font-semibold dark:text-gray-300">SOAR URL</label>
                                        <input type="url" id="soar-url" placeholder="https://<your-soar-instance>" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                    </div>
                                     <div class="mt-4">
                                        <label for="soar-api-key" class="block font-semibold dark:text-gray-300">SOAR API Key</label>
                                        <input type="password" id="soar-api-key" placeholder="Enter SOAR API Key" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                    </div>
                                </div>
                                <div class="flex space-x-2 pt-4">
                                    <button id="tenant-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Add Tenant</button>
                                    <button id="cancel-edit-btn" type="button" data-modal-hide="tenant-modal" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configurations Panel -->
            <div id="configs-panel" class="main-tab-panel hidden">
                <p class="mb-6 text-gray-600 dark:text-gray-400">Select the SecOps Tenant you wish to create your MTTx configuration for. You can configure your MTTC and MTTR parameters per tenant, and the associated SecOps YL2 query to generate the required data. MTTA and MTTD are not user configurable.</p>
                <div class="space-y-8">
                    <div class="card p-6">
                         <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Configuration Settings</h2>
                         <div>
                            <label for="config-tenant-select" class="block font-semibold mb-1 dark:text-gray-300">Select Tenant to Configure</label>
                            <select id="config-tenant-select" class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></select>
                        </div>
                    </div>

                    <div class="card">
                        <div id="config-accordion" data-accordion="collapse" class="hidden">
                            <h2 id="accordion-heading-1">
                                <button type="button" class="flex items-center justify-between w-full p-5 font-medium text-left text-gray-500 border border-b-0 border-gray-200 rounded-t-xl focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800 dark:border-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800" data-accordion-target="#accordion-body-1" aria-expanded="true" aria-controls="accordion-body-1">
                                    <span>1. MTTx Metric Definitions</span>
                                    <svg data-accordion-icon class="w-3 h-3 rotate-180 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                                </button>
                            </h2>
                            <div id="accordion-body-1" class="hidden" aria-labelledby="accordion-heading-1">
                                <div class="p-5 border border-b-0 border-gray-200 dark:border-gray-700 dark:bg-gray-900">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="card p-6">
                                             <h3 class="text-xl font-bold mb-4 dark:text-white">MTTC Configuration</h3>
                                             <form id="mttc-config-form" class="space-y-4" data-metric="MTTC">
                                                 <input type="hidden" id="mttc-config-id">
                                                 <div>
                                                     <label class="block font-semibold dark:text-gray-300">Key (Read-only)</label>
                                                     <input type="text" class="w-full p-2 border rounded-md mt-1 bg-gray-100 dark:bg-gray-600 dark:border-gray-500 dark:text-gray-300" value="case_history_stage" readonly>
                                                 </div>
                                                 <div>
                                                     <label class="block font-semibold dark:text-gray-300">Value (Select a Case Stage)</label>
                                                     <select id="mttc-config-value" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                                 </div>
                                             </form>
                                        </div>
                                        <div class="card p-6">
                                             <h3 class="text-xl font-bold mb-4 dark:text-white">MTTR Configuration</h3>
                                             <form id="mttr-config-form" class="space-y-4" data-metric="MTTR">
                                                <input type="hidden" id="mttr-config-id">
                                                <div>
                                                     <label class="block font-semibold dark:text-gray-300">Key</label>
                                                     <select id="mttr-config-key" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                                        <option value="case_history_stage">Case Stage</option>
                                                        <option value="case_history_status">Case Status</option>
                                                     </select>
                                                 </div>
                                                 <div>
                                                     <label class="block font-semibold dark:text-gray-300">Value</label>
                                                     <select id="mttr-config-value" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                                                 </div>
                                             </form>
                                        </div>
                                    </div>
                                    <button id="save-metrics-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Save Metric Definitions</button>
                                </div>
                            </div>

                            <h2 id="accordion-heading-2">
                                <button type="button" class="flex items-center justify-between w-full p-5 font-medium text-left text-gray-500 border border-b-0 border-gray-200 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800 dark:border-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800" data-accordion-target="#accordion-body-2" aria-expanded="false" aria-controls="accordion-body-2">
                                    <span>2. Data Source Queries</span>
                                    <svg data-accordion-icon class="w-3 h-3 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                                </button>
                            </h2>
                            <div id="accordion-body-2" class="hidden" aria-labelledby="accordion-heading-2">
                                <div class="p-5 border border-b-0 border-gray-200 dark:border-gray-700">
                                     <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="card p-6">
                                             <h3 class="text-xl font-bold mb-4 dark:text-white">Case History Query</h3>
                                             <form id="query-history-form">
                                                 <input type="hidden" id="query-history-id">
                                                 <textarea id="query-history-text" class="w-full p-2 border rounded-md font-mono text-sm bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300" rows="15"></textarea>
                                             </form>
                                        </div>
                                        <div class="card p-6">
                                             <h3 class="text-xl font-bold mb-4 dark:text-white">Case (MTTD) Query</h3>
                                             <form id="query-case-form">
                                                 <input type="hidden" id="query-case-id">
                                                 <textarea id="query-case-text" class="w-full p-2 border rounded-md font-mono text-sm bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-300" rows="15"></textarea>
                                             </form>
                                        </div>
                                    </div>
                                    <button id="save-queries-btn" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Save Queries</button>
                                </div>
                            </div>

                            <h2 id="accordion-heading-3">
                                <button type="button" class="flex items-center justify-between w-full p-5 font-medium text-left text-gray-500 border border-gray-200 focus:ring-4 focus:ring-gray-200 dark:border-gray-800 dark:border-gray-700 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800" data-accordion-target="#accordion-body-3" aria-expanded="false" aria-controls="accordion-body-3">
                                    <span>3. Report Thresholds</span>
                                    <svg data-accordion-icon class="w-3 h-3 shrink-0" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5 5 1 1 5"/></svg>
                                </button>
                            </h2>
                            <div id="accordion-body-3" class="hidden" aria-labelledby="accordion-heading-3">
                                <div class="p-5 border border-t-0 border-gray-200 dark:border-gray-700">
                                    <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Set the thresholds for color-coding the average metrics on the results page. Values are evaluated in order: if a metric is less than or equal to the 'Good' value, it's good. If not, it's checked against the 'Ok' value.</p>
                                    <div id="threshold-config-forms" class="overflow-x-auto"></div>
                                    <div class="flex space-x-2 mt-4">
                                        <button id="save-thresholds-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Save Thresholds</button>
                                        <button id="revert-thresholds-btn" class="w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500">Revert to Defaults</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ad-hoc Analysis Panel -->
            <div id="analysis-panel" class="main-tab-panel hidden">
                <p class="mb-6 text-gray-600 dark:text-gray-400">Select a Tenant, specify a relative time range, and click Generate Report to view the MTTx metrics.</p>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Analysis Parameters</h2>
                    <div class="space-y-4 max-w-2xl">
                        <div>
                            <label for="analysis-tenant-select" class="block font-semibold dark:text-gray-300">Select Tenant</label>
                            <select id="analysis-tenant-select" class="w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        </div>
                        <div>
                            <label class="block font-semibold dark:text-gray-300">Select Relative Time Range</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="number" id="start-time-val" class="w-1/2 p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="3">
                                <select id="time-unit" class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                    <option value="DAY">Days</option>
                                    <option value="HOUR">Hours</option>
                                    <option value="MINUTE">Minutes</option>
                                </select>
                            </div>
                        </div>
                        <button id="run-analysis-btn" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition">Generate Report</button>
                    </div>
                </div>
            </div>

            <!-- MTTx Results Panel -->
            <div id="results-panel" class="main-tab-panel hidden">
               
                <!-- Show Filters Button -->
                <div class="mb-4">
                    <button id="show-filters-modal-btn" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800" type="button">
                        Filter Results
                    </button>
                </div>

                <!-- Active Filter Pills -->
                <div id="active-filters-pills" class="my-4 flex flex-wrap items-center gap-2"></div>

                <div id="mttx-results-container">
                     <p class="text-gray-500 dark:text-gray-400">Calculate metrics to see results.</p>
                </div>
            </div>

            <!-- Filters Modal -->
            <div id="filters-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
                 <div class="relative p-4 w-full max-w-[90%] max-h-full">
                     <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
                         <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600">
                             <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                                 Report Filters
                             </h3>
                             <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="filters-modal">
                                 <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                                 <span class="sr-only">Close modal</span>
                             </button>
                         </div>
                         <div class="p-4 md:p-5">

                            <button type="button" id="toggle-filter-lists-btn" class="text-sm text-blue-600 dark:text-blue-400 hover:underline mb-4 block">
                                Expand All Lists
                            </button>

                             <div id="filter-body" class="space-y-6">
                                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                     <div>
                                         <label for="environment-search" class="block font-semibold mb-1 dark:text-gray-300">Search Environments</label>
                                         <input type="text" id="environment-search" placeholder="Filter environments..." class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                          <div id="environment-filter-options" class="grid grid-cols-1 gap-2 p-2 mt-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-600 filter-options-list collapsed">
                                            <label class="flex items-center space-x-2">
                                                <input type="checkbox" value="Cymbal" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500">
                                                <span class="text-sm text-gray-700 dark:text-gray-300">Cymbal</span>
                                            </label>
                                            <label class="flex items-center space-x-2">
                                                <input type="checkbox" value="Default Environment" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500">
                                                <span class="text-sm text-gray-700 dark:text-gray-300">Default Environment</span>
                                            </label>
                                            <label class="flex items-center space-x-2">
                                                <input type="checkbox" value="LogStory" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500">
                                                <span class="text-sm text-gray-700 dark:text-gray-300">LogStory</span>
                                            </label>
                                          </div>
                                     </div>
                                     <div>
                                         <label for="rule-search" class="block font-semibold mb-1 dark:text-gray-300">Search Detection Rules</label>
                                         <input type="text" id="rule-search" placeholder="Filter rules..." class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                         <div id="rule-filter-options" class="grid grid-cols-1 gap-2 p-2 mt-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-600 filter-options-list collapsed"></div>
                                     </div>
                                     <div>
                                         <label for="tag-search" class="block font-semibold mb-1 dark:text-gray-300">Search Tags</label>
                                         <input type="text" id="tag-search" placeholder="Filter tags..." class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                         <div id="tag-filter-options" class="grid grid-cols-1 gap-2 p-2 mt-2 border rounded-md bg-gray-50 dark:bg-gray-800 dark:border-gray-600 filter-options-list collapsed"></div>
                                         <label for="filter-mode" class="block font-semibold mb-1 mt-4 dark:text-gray-300">Tag Filter Mode</label>
                                         <select id="filter-mode" class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                             <option value="exclude">Exclude cases with selected tags</option>
                                             <option value="include">Include ONLY cases with selected tags</option>
                                         </select>
                                     </div>
                                 </div>
                                 <div class="flex space-x-2">
                                     <button id="apply-filters-btn" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Apply Filters</Vbutton>
                                     <button id="clear-filters-btn" class="w-full md:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500">Clear Filters</button>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
            
            <!-- Signal to Noise Panel -->
            <div id="signal-panel" class="main-tab-panel hidden">
                <p class="mb-6 text-gray-600 dark:text-gray-400">Plot True Positive against True Positive - Benign, or False Positive detections to see which Detection Rules are providing value, or not.</p>
                 <div class="card p-6 mb-8">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Chart Configuration</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="signal-tags-select" class="block font-semibold mb-1 dark:text-gray-300">Signal Tags (Y-Axis)</label>
                            <select id="signal-tags-select" multiple class="w-full p-2 border rounded-md bg-gray-50 h-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        </div>
                        <div>
                            <label for="noise-tags-select" class="block font-semibold mb-1 dark:text-gray-300">Noise Tags (X-Axis)</label>
                            <select id="noise-tags-select" multiple class="w-full p-2 border rounded-md bg-gray-50 h-32 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        </div>
                    </div>
                    <button id="generate-chart-btn" class="mt-4 w-full md:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Generate Chart</button>
                </div>
                 <div class="card p-6">
                    <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Detection Rule Signal to Noise Quadrant</h2>
                    <p class="text-gray-600 mb-4 dark:text-gray-400">Each bubble represents a detection rule. Size indicates total alert volume. Use filters on the 'MTTx Results' tab to refine this view.</p>
                    <div class="relative h-[600px]">
                        <canvas id="signal-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-success" class="fixed top-5 right-5 z-50 hidden flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg dark:bg-green-800 dark:text-green-200">
            <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/>
            </svg>
            <span class="sr-only">Check icon</span>
        </div>
        <div id="toast-success-msg" class="ms-3 text-sm font-normal">Item moved successfully.</div>
        <button type="button" class="ms-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-success" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
        </button>
    </div>

    <div id="toast-danger" class="fixed top-5 right-5 z-50 hidden flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800" role="alert">
        <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg dark:bg-red-800 dark:text-red-200">
            <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/>
            </svg>
            <span class="sr-only">Error icon</span>
        </div>
        <div id="toast-danger-msg" class="ms-3 text-sm font-normal">Item has been deleted.</div>
        <button type="button" class="ms-auto -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8 dark:text-gray-500 dark:hover:text-white dark:bg-gray-800 dark:hover:bg-gray-700" data-dismiss-target="#toast-danger" aria-label="Close">
            <span class="sr-only">Close</span>
            <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
            </svg>
        </button>
    </div>

    <footer class="fixed bottom-0 right-0 p-4">
        <span id="app-version" class="text-xs text-gray-500 dark:text-gray-400"></span>
    </footer>

    <!-- Main modal -->
    <div id="default-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 justify-center items-center w-full md:inset-0 h-[calc(100%-1rem)] max-h-full">
        <div class="relative p-4 w-full max-w-2xl max-h-full">
            <!-- Modal content -->
            <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
                <!-- Modal header -->
                <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                    <h3 id="modal-title" class="text-xl font-semibold text-gray-900 dark:text-white">
                        Confirmation
                    </h3>
                    <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="default-modal">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                        <span class="sr-only">Close modal</span>
                    </button>
                </div>
                <!-- Modal body -->
                <div class="p-4 md:p-5 space-y-4">
                    <p id="modal-body" class="text-base leading-relaxed text-gray-500 dark:text-gray-400">
                        Are you sure you want to proceed?
                    </p>
                </div>
                <!-- Modal footer -->
                <div class="flex items-center p-4 md:p-5 border-t border-gray-200 rounded-b dark:border-gray-600">
                    <button id="modal-confirm-btn" type="button" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Yes</button>
                    <button id="modal-decline-btn" type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700">No</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api';

        // Global State
        let caseHistoryData = null;
        let caseMttdData = null;
        let fullMetricsData = null;
        let allCaseStages = [];
        let allCaseStatuses = [];
        let signalChart = null;
        let sortColumn = 'case_id';
        let sortDirection = 'asc';
        let filtersModal = null;
        let confirmationModal = null;
        let defaultModal = null;
        let showDetailsState = true;
        let selectedUnitState = 'MINUTES';

        // Element References
        const tenantList = document.getElementById('tenant-list');
        const tenantSelectForAnalysis = document.getElementById('analysis-tenant-select');
        const tenantSelectForConfig = document.getElementById('config-tenant-select');
        const tenantSelectForScheduler = document.getElementById('scheduler-tenant-select');
        const addTenantForm = document.getElementById('add-tenant-form');
        const mttxConfigForms = document.getElementById('mttx-config-forms');
        const queryConfigForms = document.getElementById('query-config-forms');
        
        // Tab Switching Logic
        const mainTabs = document.querySelectorAll('.tab-btn');
        const mainTabPanels = document.querySelectorAll('.main-tab-panel');

        const fetchVersion = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/version`);
                if (!response.ok) return;
                const data = await response.json();
                document.getElementById('app-version').textContent = `v${data.version}`;
            } catch (error) {
                console.error("Could not fetch version:", error);
            }
        };

        const switchMainTab = (targetPanelId) => {
            mainTabPanels.forEach(p => p.classList.toggle('hidden', p.id !== targetPanelId));
            mainTabs.forEach(t => {
                t.classList.toggle('tab-active', t.dataset.target === targetPanelId);
                t.classList.toggle('tab-inactive', t.dataset.target !== targetPanelId);
            });
            if (targetPanelId === 'configs-panel') {
                const selectedTenantId = tenantSelectForConfig.value;
                if (selectedTenantId && !isNaN(selectedTenantId)) {
                    loadAndDisplayConfigs(selectedTenantId);
                }
            } else if (targetPanelId === 'scheduler-panel') {
                const selectedTenantId = tenantSelectForScheduler.value;
                if (selectedTenantId && !isNaN(selectedTenantId)) {
                    loadAndDisplaySchedules(selectedTenantId);
                }
            } else if (targetPanelId === 'signal-panel') {
                if (fullMetricsData) {
                    populateSignalNoiseSelectors();
                    generateQuadrantChart();
                }
            }
        };

        mainTabs.forEach(t => t.addEventListener('click', () => switchMainTab(t.dataset.target)));

        // --- Scheduler Logic ---
        const loadAndDisplaySchedules = async (tenantId) => {
            const schedulerContent = document.getElementById('scheduler-content');
            if (!tenantId || isNaN(tenantId)) {
                schedulerContent.classList.add('hidden');
                return;
            }
            schedulerContent.classList.remove('hidden');
            schedulerContent.innerHTML = '<p>Loading schedules...</p>';

            try {
                const response = await fetch(`${API_BASE_URL}/tenants/${tenantId}/schedules`);
                if (!response.ok) throw new Error('Failed to fetch schedules');
                const schedules = await response.json();
                renderSchedulesTable(schedules, tenantId);
            } catch (error) {
                schedulerContent.innerHTML = `<p class="text-red-500">Error loading schedules: ${error.message}</p>`;
            }
        };

        const scheduleModal = new Modal(document.getElementById('schedule-modal'));

        const showScheduleModal = (schedule = null) => {
            const tenantId = tenantSelectForScheduler.value;
            if (!tenantId) {
                showToast('Please select a tenant first.', 'danger');
                return;
            }
            
            const modalTitle = document.getElementById('schedule-modal-title');
            const form = document.getElementById('schedule-form');
            const destinationsContainer = document.getElementById('destinations-container');
            
            if (schedule) {
                modalTitle.textContent = `Edit Schedule: ${schedule.id}`;
                renderScheduleForm(form, schedule);
                renderDestinations(destinationsContainer, schedule.id);
            } else {
                modalTitle.textContent = 'Create New Schedule';
                renderScheduleForm(form, { tenant_id: tenantId });
                destinationsContainer.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">Save the schedule to add output destinations.</p>';
            }
            scheduleModal.show();
        };

        const renderSchedulesTable = (schedules, tenantId) => {
            const container = document.getElementById('scheduler-content');
            container.innerHTML = ''; // Clear previous content

            if (schedules.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No schedules found for this tenant.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200 dark:divide-gray-700';
            table.innerHTML = `
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Cron Schedule</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Report Range</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Outputs</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Enabled</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-900 dark:divide-gray-700"></tbody>
            `;
            const tbody = table.querySelector('tbody');

            schedules.forEach(schedule => {
                const row = document.createElement('tr');
                const outputs = [
                    schedule.output_avg_metrics ? 'Metrics' : '',
                    schedule.output_completion_rates ? 'Rates' : '',
                    schedule.output_individual_cases ? 'Cases' : ''
                ].filter(Boolean).join(', ');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900 dark:text-gray-200">${schedule.cron_schedule}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${schedule.start_time_val} ${schedule.time_unit}(s)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${outputs}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <label class="inline-flex items-center cursor-pointer">
                          <input type="checkbox" value="" class="sr-only peer" ${schedule.is_enabled ? 'checked' : ''}>
                          <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                        </label>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <button class="edit-schedule-btn text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" data-schedule-id="${schedule.id}">Edit</button>
                        <button class="test-schedule-btn text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300" data-schedule-id="${schedule.id}">Test Run</button>
                        <button class="delete-schedule-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" data-schedule-id="${schedule.id}">Delete</button>
                    </td>
                `;
                row.querySelector('.edit-schedule-btn').addEventListener('click', () => showScheduleModal(schedule));
                // Add event listeners for test and delete
                tbody.appendChild(row);
            });

            container.appendChild(table);
        };
        
        const renderScheduleForm = (formElement, scheduleData) => {
            const isNew = !scheduleData.id;
            const inputClasses = "w-full p-2 border rounded-md mt-1 bg-white text-gray-900 border-gray-300 placeholder-gray-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white";
            const selectClasses = "w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white";

            formElement.innerHTML = `
                <input type="hidden" name="schedule_id" value="${scheduleData.id || ''}">
                <input type="hidden" name="tenant_id" value="${scheduleData.tenant_id}">
                <div>
                    <label class="block font-semibold dark:text-gray-300">Cron Schedule</label>
                    <input type="text" name="cron_schedule" class="${inputClasses}" placeholder="e.g., 0 2 * * *" value="${scheduleData.cron_schedule || ''}" required>
                    <p class="text-xs text-gray-500 mt-1 dark:text-gray-400">Use standard cron format (minute hour day(month) month day(week)).</p>
                </div>
                <div>
                    <label class="block font-semibold dark:text-gray-300">Report Time Range</label>
                    <div class="flex items-center space-x-2 mt-1">
                        <input type="number" name="start_time_val" class="w-1/2 ${inputClasses}" value="${scheduleData.start_time_val || 7}">
                        <select name="time_unit" class="${selectClasses}">
                            <option value="DAY" ${scheduleData.time_unit === 'DAY' ? 'selected' : ''}>Days</option>
                            <option value="HOUR" ${scheduleData.time_unit === 'HOUR' ? 'selected' : ''}>Hours</option>
                            <option value="MINUTE" ${scheduleData.time_unit === 'MINUTE' ? 'selected' : ''}>Minutes</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block font-semibold dark:text-gray-300">Metrics to Output</label>
                    <div class="mt-2 space-y-2">
                        <label class="flex items-center"><input type="checkbox" name="output_avg_metrics" class="h-4 w-4 rounded border-gray-300" ${scheduleData.output_avg_metrics !== false ? 'checked' : ''}> <span class="ml-2 dark:text-gray-300">Average Metrics</span></label>
                        <label class="flex items-center"><input type="checkbox" name="output_completion_rates" class="h-4 w-4 rounded border-gray-300" ${scheduleData.output_completion_rates !== false ? 'checked' : ''}> <span class="ml-2 dark:text-gray-300">Completion Rates</span></label>
                        <label class="flex items-center"><input type="checkbox" name="output_individual_cases" class="h-4 w-4 rounded border-gray-300" ${scheduleData.output_individual_cases ? 'checked' : ''}> <span class="ml-2 dark:text-gray-300">Individual Cases</span></label>
                    </div>
                </div>
                 <div>
                    <label class="flex items-center"><input type="checkbox" name="is_enabled" class="h-4 w-4 rounded border-gray-300" ${scheduleData.is_enabled !== false ? 'checked' : ''}> <span class="ml-2 font-semibold dark:text-gray-300">Is Enabled</span></label>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">${isNew ? 'Create Schedule' : 'Update Schedule'}</button>
            `;
            formElement.addEventListener('submit', handleScheduleFormSubmit);
        };

        const handleScheduleFormSubmit = async (event) => {
            event.preventDefault();
            const form = event.target;
            const scheduleId = form.schedule_id.value;
            const tenantId = form.tenant_id.value;
            const isNew = !scheduleId;

            const scheduleData = {
                tenant_id: parseInt(tenantId),
                cron_schedule: form.cron_schedule.value,
                time_unit: form.time_unit.value,
                start_time_val: parseInt(form.start_time_val.value),
                output_avg_metrics: form.output_avg_metrics.checked,
                output_completion_rates: form.output_completion_rates.checked,
                output_individual_cases: form.output_individual_cases.checked,
                is_enabled: form.is_enabled.checked
            };

            const url = isNew ? `${API_BASE_URL}/schedules` : `${API_BASE_URL}/schedules/${scheduleId}`;
            const method = isNew ? 'POST' : 'PUT';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(scheduleData)
                });
                if (!response.ok) throw new Error(await response.text());
                showToast(`Schedule ${isNew ? 'created' : 'updated'} successfully!`);
                loadAndDisplaySchedules(tenantId);
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        };
        
        const renderDestinations = async (container, scheduleId) => {
            try {
                const response = await fetch(`${API_BASE_URL}/schedules/${scheduleId}/destinations`);
                const destinations = await response.json();
                
                container.innerHTML = ''; // Clear
                destinations.forEach(dest => {
                    const destForm = document.createElement('form');
                    destForm.className = 'p-4 bg-gray-50 rounded-md mb-2 dark:bg-gray-800';
                    let pathOrNameInput = '';
                    if (dest.destination_type === 'CSV') {
                        pathOrNameInput = `
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300">File Path</label>
                            <input type="text" name="path" class="w-full p-2 border rounded-md mt-1 text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${dest.path || ''}" placeholder="/path/to/output.csv">
                        </div>`;
                    } else if (dest.destination_type === 'DATA_TABLE') {
                        pathOrNameInput = `
                        <div>
                            <label class="block text-sm font-medium dark:text-gray-300">Data Table Name</label>
                            <input type="text" name="data_table_name" class="w-full p-2 border rounded-md mt-1 text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${dest.data_table_name || ''}" placeholder="e.g., MTTx_Results">
                        </div>`;
                    }

                    destForm.innerHTML = `
                        <input type="hidden" name="destination_id" value="${dest.id}">
                        <input type="hidden" name="schedule_id" value="${scheduleId}">
                        <input type="hidden" name="destination_type" value="${dest.destination_type}">
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-semibold dark:text-white">Destination: ${dest.destination_type}</p>
                            <button type="button" class="delete-destination-btn text-xs bg-red-100 text-red-700 font-semibold py-1 px-2 rounded-lg hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800" data-destination-id="${dest.id}">Delete</button>
                        </div>
                        ${pathOrNameInput}
                        <div class="mt-2">
                            <label class="flex items-center"><input type="checkbox" name="is_enabled" class="h-4 w-4 rounded" ${dest.is_enabled ? 'checked' : ''}> <span class="ml-2 text-sm dark:text-gray-300">Enabled</span></label>
                        </div>
                        <div class="flex space-x-2 mt-4">
                            <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Update Destination</button>
                            ${dest.destination_type === 'DATA_TABLE' ? `<button type="button" class="create-dashboard-btn w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition" data-destination-id="${dest.id}">Create Dashboard</button>` : ''}
                        </div>
                    `;
                    container.appendChild(destForm);
                });

                // Add "New Destination" form
                const newDestForm = document.createElement('form');
                newDestForm.className = 'p-4 border-t dark:border-gray-600';
                newDestForm.innerHTML = `
                    <h5 class="font-semibold mb-2 dark:text-white">Add New Destination</h5>
                    <input type="hidden" name="schedule_id" value="${scheduleId}">
                    <div>
                        <label class="block text-sm font-medium dark:text-gray-300">Destination Type</label>
                        <select name="destination_type" class="w-full p-2 border rounded-md mt-1 text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="CSV">CSV</option>
                            <option value="DATA_TABLE">Data Table</option>
                        </select>
                    </div>
                    <div class="mt-2" id="destination-path-container-${scheduleId}">
                        <label class="block text-sm font-medium dark:text-gray-300">File Path</label>
                        <input type="text" name="path" class="w-full p-2 border rounded-md mt-1 text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="/path/to/output.csv" required>
                    </div>
                    <div class="mt-2 hidden" id="destination-data-table-container-${scheduleId}">
                        <label class="block text-sm font-medium dark:text-gray-300">Data Table Name (Optional)</label>
                        <input type="text" name="data_table_name" class="w-full p-2 border rounded-md mt-1 text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Default: mttx_schedule_${scheduleId}_<type>">
                    </div>
                    <button type="submit" class="mt-4 w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Add Destination</button>
                `;
                container.appendChild(newDestForm);
                
                const destTypeSelect = newDestForm.querySelector('select[name="destination_type"]');
                destTypeSelect.addEventListener('change', (e) => {
                    const pathContainer = document.getElementById(`destination-path-container-${scheduleId}`);
                    const dataTableContainer = document.getElementById(`destination-data-table-container-${scheduleId}`);
                    const pathInput = pathContainer.querySelector('input');
                    if (e.target.value === 'DATA_TABLE') {
                        pathContainer.classList.add('hidden');
                        pathInput.required = false;
                        dataTableContainer.classList.remove('hidden');
                    } else { // CSV
                        pathContainer.classList.remove('hidden');
                        pathInput.required = true;
                        dataTableContainer.classList.add('hidden');
                    }
                });

            } catch (error) {
                container.innerHTML = `<p class="text-red-500">Could not load destinations.</p>`;
            }
        };
        
        document.getElementById('scheduler-content').addEventListener('click', async function(event) {
            if (event.target.classList.contains('test-schedule-btn')) {
                const scheduleId = event.target.dataset.scheduleId;
                event.target.textContent = 'Testing...';
                event.target.disabled = true;
                try {
                    const response = await fetch(`${API_BASE_URL}/schedules/${scheduleId}/run`, { method: 'POST' });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.detail || 'Failed to start test run.');
                    showToast(result.message);
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'danger');
                } finally {
                    event.target.textContent = 'Test Run';
                    event.target.disabled = false;
                }
            }
            if (event.target.classList.contains('delete-schedule-btn')) {
                const scheduleId = event.target.dataset.scheduleId;
                const confirmed = await showModal('Are you sure you want to delete this entire schedule and its destinations?');
                if (confirmed) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/schedules/${scheduleId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete schedule');
                        showToast('Schedule deleted.');
                        loadAndDisplaySchedules(tenantSelectForScheduler.value);
                    } catch (error) { showToast(`Error: ${error.message}`, 'danger'); }
                }
            }
        });

        document.getElementById('schedule-modal').addEventListener('submit', async function(event) {
            const form = event.target;
            // This condition is now more general to catch both the <select> in the "new" form 
            // and the <input> in the "update" forms.
            if (form.querySelector('[name="destination_type"]')) {
                event.preventDefault();
                const destId = form.destination_id ? form.destination_id.value : null;
                const scheduleId = form.schedule_id.value;
                const isNew = !destId;
                
                const data = {
                    schedule_id: parseInt(scheduleId),
                    destination_type: form.destination_type.value,
                    path: form.path ? form.path.value : null,
                    data_table_name: form.data_table_name ? form.data_table_name.value : null,
                    is_enabled: form.is_enabled ? form.is_enabled.checked : true
                };

                const url = isNew ? `${API_BASE_URL}/destinations` : `${API_BASE_URL}/destinations/${destId}`;
                const method = isNew ? 'POST' : 'PUT';

                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                    if (!response.ok) throw new Error(await response.text());
                    showToast(`Destination ${isNew ? 'added' : 'updated'}.`);
                    renderDestinations(document.getElementById('destinations-container'), scheduleId);
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'danger');
                }
            }
        });

        document.getElementById('schedule-modal').addEventListener('click', async function(event) {
            if (event.target.classList.contains('delete-destination-btn')) {
                const destinationId = event.target.dataset.destinationId;
                const form = event.target.closest('form');
                const scheduleId = form.querySelector('input[name="schedule_id"]').value;
                const confirmed = await showModal('Are you sure you want to delete this destination?');
                 if (confirmed) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/destinations/${destinationId}`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Failed to delete destination');
                        showToast('Destination deleted.');
                        renderDestinations(document.getElementById('destinations-container'), scheduleId);
                    } catch (error) { showToast(`Error: ${error.message}`, 'danger'); }
                }
            }
            if (event.target.classList.contains('create-dashboard-btn')) {
                const destinationId = event.target.dataset.destinationId;
                handleCreateDashboard(destinationId, event.target);
            }
        });

        const handleCreateDashboard = async (destinationId, buttonElement) => {
            buttonElement.textContent = 'Creating...';
            buttonElement.disabled = true;
            try {
                const response = await fetch(`${API_BASE_URL}/destinations/${destinationId}/create-dashboard`, { method: 'POST' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.detail || 'Failed to create dashboard.');
                
                let successMessage = result.message;
                if (result.dashboard_url) {
                    successMessage += `\n\nYou can view it here: ${result.dashboard_url}`;
                }
                showToast(successMessage);

            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            } finally {
                buttonElement.textContent = 'Create Dashboard';
                buttonElement.disabled = false;
            }
        };


        // --- Tenant Logic ---
        const tenantModal = new Modal(document.getElementById('tenant-modal'));

        const showTenantModal = (tenant = null) => {
            if (tenant) {
                document.getElementById('tenant-id').value = tenant.id;
                document.getElementById('tenant-name').value = tenant.name;
                document.getElementById('tenant-guid').value = tenant.guid;
                document.getElementById('tenant-gcp-project').value = tenant.gcp_project_id;
                document.getElementById('tenant-region').value = tenant.region;
                document.getElementById('base-url').value = tenant.base_url || '';
                document.getElementById('soar-url').value = tenant.soar_url || '';
                document.getElementById('soar-api-key').value = tenant.soar_api_key || '';
                document.getElementById('tenant-modal-title').textContent = `Edit Tenant: ${tenant.name}`;
                document.getElementById('tenant-submit-btn').textContent = 'Update Tenant';
            } else {
                addTenantForm.reset();
                document.getElementById('tenant-id').value = '';
                document.getElementById('tenant-modal-title').textContent = 'Add New Tenant';
                document.getElementById('tenant-submit-btn').textContent = 'Add Tenant';
            }
            tenantModal.show();
        };

        const startEditTenant = (tenant) => {
            showTenantModal(tenant);
        };

        const showToast = (message, type = 'success') => {
            let toastId, msgId;
            if (type === 'success') {
                toastId = 'toast-success';
                msgId = 'toast-success-msg';
            } else {
                toastId = 'toast-danger';
                msgId = 'toast-danger-msg';
            }

            const $targetEl = document.getElementById(toastId);
            if (!$targetEl) {
                console.error('Toast HTML element not found:', toastId);
                alert(message); // Fallback
                return;
            }

            // Set the message
            document.getElementById(msgId).textContent = message;

            // Manually show the toast
            $targetEl.classList.remove('hidden');
            $targetEl.classList.add('flex');

            // Manually hide it after 3 seconds
            setTimeout(() => {
                $targetEl.classList.add('hidden');
                $targetEl.classList.remove('flex');
            }, 3000);
        };

        const handleTestTenant = async (tenantId, statusEl) => {
            statusEl.textContent = 'Testing...';
            statusEl.className = 'status-badge bg-yellow-100 text-yellow-800';
            try {
                const response = await fetch(`${API_BASE_URL}/tenants/${tenantId}/test`, { method: 'POST' });
                const result = await response.json();
                statusEl.textContent = result.status === 'success' ? 'Success' : 'Failed';
                statusEl.className = `status-badge ${result.status === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                if(result.status !== 'success') showToast(`Connection Test Failed: ${result.message || 'Unknown error'}`, 'danger');
            } catch (error) {
                statusEl.textContent = 'Failed';
                statusEl.className = 'status-badge bg-red-100 text-red-800';
            }
        };

        const handleDeleteTenant = async (tenantId) => {
            const confirmed = await showModal('Are you sure you want to delete this tenant and all its associated configurations? This action cannot be undone.');
            if (confirmed) {
                try {
                    const response = await fetch(`${API_BASE_URL}/tenants/${tenantId}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to delete tenant');
                    }
                    showToast('Tenant deleted successfully.');
                    fetchTenants();
                } catch (error) {
                    showToast(`Error: ${error.message}`, 'danger');
                }
            }
        };

        const showModal = (message, title = 'Confirmation') => {
            return new Promise((resolve) => {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').textContent = message;

                const confirmBtn = document.getElementById('modal-confirm-btn');
                const declineBtn = document.getElementById('modal-decline-btn');

                const confirmClickHandler = () => {
                    defaultModal.hide();
                    resolve(true);
                    cleanup();
                };

                const declineClickHandler = () => {
                    defaultModal.hide();
                    resolve(false);
                    cleanup();
                };

                const cleanup = () => {
                    confirmBtn.removeEventListener('click', confirmClickHandler);
                    declineBtn.removeEventListener('click', declineClickHandler);
                };

                confirmBtn.addEventListener('click', confirmClickHandler);
                declineBtn.addEventListener('click', declineClickHandler);

                defaultModal.show();
            });
        };

        const renderTenants = (tenants) => {
            const selects = [tenantSelectForAnalysis, tenantSelectForConfig, tenantSelectForScheduler];
            const instructions = document.getElementById('tenant-instructions');
            tenantList.innerHTML = '';
            selects.forEach(s => s.innerHTML = '');
            if (tenants.length === 0) {
                instructions.classList.remove('hidden');
                const noTenantMsg = `<li class="p-2 text-gray-500 dark:text-gray-400">No tenants configured.</li>`;
                const noTenantOption = `<option>Please add a tenant first</option>`;
                tenantList.innerHTML = noTenantMsg;
                selects.forEach(s => s.innerHTML = noTenantOption);
            } else {
                instructions.classList.add('hidden');
                tenants.forEach(tenant => {
                    const li = document.createElement('li');
                    li.className = 'p-3 bg-gray-50 rounded-md flex justify-between items-center dark:bg-gray-700';
                    li.innerHTML = `<div class="font-semibold text-gray-700 dark:text-gray-200">${tenant.name}</div>`;
                    const controls = document.createElement('div');
                    controls.className = 'flex items-center space-x-2';
                    controls.innerHTML = `
                        <span id="status-${tenant.id}" class="status-badge bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300">Untested</span>
                        <button class="edit-btn text-sm bg-white font-semibold py-1 px-3 border rounded-lg shadow-sm hover:bg-gray-50 dark:bg-gray-600 dark:text-gray-300 dark:border-gray-500 dark:hover:bg-gray-500">Edit</button>
                        <button class="test-btn text-sm bg-white font-semibold py-1 px-3 border rounded-lg shadow-sm hover:bg-gray-50 dark:bg-gray-600 dark:text-gray-300 dark:border-gray-500 dark:hover:bg-gray-500">Test</button>
                        <button class="delete-btn text-sm bg-red-100 text-red-700 font-semibold py-1 px-2 rounded-lg hover:bg-red-200 dark:bg-red-900 dark:text-red-300 dark:hover:bg-red-800">Delete</button>`;
                    controls.querySelector('.edit-btn').onclick = () => startEditTenant(tenant);
                    controls.querySelector('.test-btn').onclick = () => handleTestTenant(tenant.id, controls.querySelector(`#status-${tenant.id}`));
                    controls.querySelector('.delete-btn').onclick = () => handleDeleteTenant(tenant.id);
                    li.appendChild(controls);
                    tenantList.appendChild(li);
                    
                    const option = new Option(tenant.name, tenant.id);
                    selects.forEach(s => s.add(option.cloneNode(true)));
                });
            }
        };

        const fetchTenants = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/tenants`);
                if (!response.ok) throw new Error('Failed to fetch tenants');
                renderTenants(await response.json());
            } catch (error) {
                tenantList.innerHTML = `<li class="p-2 text-red-500">Failed to load tenants.</li>`;
            }
        };

        // --- Configuration Logic ---
        const populateSelectWithOptions = (selectElement, options, selectedValue) => {
            selectElement.innerHTML = '';
            options.forEach(opt => {
                const option = new Option(opt.text, opt.value);
                selectElement.add(option);
            });
            if (selectedValue) selectElement.value = selectedValue;
        };

        const updateMttrValueOptions = () => {
            const keySelect = document.getElementById('mttr-config-key');
            const valueSelect = document.getElementById('mttr-config-value');
            const source = keySelect.value === 'case_history_stage' ? allCaseStages : allCaseStatuses;
            populateSelectWithOptions(valueSelect, source.map(s => ({ value: s.name, text: s.name })));
        };
        
        const loadAndDisplayConfigs = async (tenantId) => {
             if (!tenantId || isNaN(tenantId)) {
                document.getElementById('config-accordion').classList.add('hidden');
                return;
            }
            try {
                document.getElementById('config-accordion').classList.remove('hidden');

                const [statusesRes, configsRes, queriesRes, thresholdsRes] = await Promise.all([
                    fetch(`${API_BASE_URL}/case-statuses`),
                    fetch(`${API_BASE_URL}/tenants/${tenantId}/mttx-configs`),
                    fetch(`${API_BASE_URL}/tenants/${tenantId}/queries`),
                    fetch(`${API_BASE_URL}/tenants/${tenantId}/thresholds`)
                ]);

                allCaseStatuses = await statusesRes.json();
                const configs = await configsRes.json();
                const queries = await queriesRes.json();
                const thresholds = await thresholdsRes.json();
                
                renderThresholdsForm(thresholds);
                document.getElementById('save-thresholds-btn').addEventListener('click', handleThresholdFormSubmit);
                document.getElementById('revert-thresholds-btn').addEventListener('click', handleRevertThresholds);

                let stagesResponse = await fetch(`${API_BASE_URL}/tenants/${tenantId}/stages`);
                allCaseStages = await stagesResponse.json();
                if (allCaseStages.length === 0) {
                    const fetchSoarResponse = await fetch(`${API_BASE_URL}/tenants/${tenantId}/fetch-stages`, { method: 'POST' });
                    if (!fetchSoarResponse.ok) throw new Error((await fetchSoarResponse.json()).detail);
                    allCaseStages = await (await fetch(`${API_BASE_URL}/tenants/${tenantId}/stages`)).json();
                }

                const mttcConfig = configs.find(c => c.metric_type === 'MTTC');
                if (mttcConfig) {
                    document.getElementById('mttc-config-id').value = mttcConfig.id;
                    populateSelectWithOptions(document.getElementById('mttc-config-value'), allCaseStages.map(s => ({ value: s.name, text: s.name })), mttcConfig.config_value);
                }
                const mttrConfig = configs.find(c => c.metric_type === 'MTTR');
                if (mttrConfig) {
                    document.getElementById('mttr-config-id').value = mttrConfig.id;
                    document.getElementById('mttr-config-key').value = mttrConfig.config_key;
                    updateMttrValueOptions();
                    document.getElementById('mttr-config-value').value = mttrConfig.config_value;
                }
                
                const historyQuery = queries.find(q => q.name === 'query_history');
                if(historyQuery) {
                    document.getElementById('query-history-id').value = historyQuery.id;
                    document.getElementById('query-history-text').value = historyQuery.query_text;
                }
                const caseQuery = queries.find(q => q.name === 'query_case');
                if(caseQuery) {
                    document.getElementById('query-case-id').value = caseQuery.id;
                    document.getElementById('query-case-text').value = caseQuery.query_text;
                }

            } catch (error) {
                showToast(`Error loading configurations: ${error.message}`, 'danger');
                document.getElementById('config-accordion').classList.add('hidden');
            }
        };

        const renderThresholdsForm = (thresholds) => {
            const container = document.getElementById('threshold-config-forms');
            container.innerHTML = ''; // Clear previous content

            const timeUnits = { SECOND: 1, MINUTE: 60, HOUR: 3600, DAY: 86400 };
            const getBestUnit = (seconds) => {
                if (seconds >= 86400 && seconds % 86400 === 0) return 'DAY';
                if (seconds >= 3600 && seconds % 3600 === 0) return 'HOUR';
                if (seconds >= 60 && seconds % 60 === 0) return 'MINUTE';
                return 'SECOND';
            };

            const createTable = (title, operator) => {
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 dark:divide-gray-700 mb-8';
                table.innerHTML = `
                    <caption class="text-lg font-semibold text-left text-gray-700 dark:text-gray-200 py-2">${title}</caption>
                    <thead class="bg-gray-50 dark:bg-gray-800">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Metric</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Good (${operator})</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Ok (${operator})</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Good Color</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Ok Color</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Bad Color</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 dark:bg-gray-900 dark:divide-gray-700"></tbody>
                `;
                return table;
            };

            const timeTable = createTable('Time-Based Metrics (Lower is Better)', '');
            const percentTable = createTable('Completion Metrics (Higher is Better)', '');
            const timeTbody = timeTable.querySelector('tbody');
            const percentTbody = percentTable.querySelector('tbody');

            thresholds.forEach(t => {
                const row = document.createElement('tr');
                row.dataset.metricName = t.metric_name;
                let valueInputs;

                if (t.metric_name.includes('percent')) {
                    valueInputs = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <input type="number" data-metric="${t.metric_name}" name="good_value" class="w-24 p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${t.good_threshold}">
                                <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <input type="number" data-metric="${t.metric_name}" name="ok_value" class="w-24 p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${t.ok_threshold}">
                                <span class="ml-2 text-gray-500 dark:text-gray-400">%</span>
                            </div>
                        </td>`;
                     row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">${t.metric_name.replace(/_/g, ' ').replace('percent', '(%)')}</td>
                        ${valueInputs}
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="good_color" class="w-full h-10 p-1 border rounded-md" value="${t.good_color}"></td>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="ok_color" class="w-full h-10 p-1 border rounded-md" value="${t.ok_color}"></td>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="bad_color" class="w-full h-10 p-1 border rounded-md" value="${t.bad_color}"></td>
                    `;
                    percentTbody.appendChild(row);
                } else {
                    const goodUnit = getBestUnit(t.good_threshold);
                    const okUnit = getBestUnit(t.ok_threshold);
                    const goodValue = t.good_threshold / timeUnits[goodUnit];
                    const okValue = t.ok_threshold / timeUnits[okUnit];
                    const unitOptions = Object.keys(timeUnits).map(unit => `<option value="${unit}" ${unit === goodUnit ? 'selected' : ''}>${unit.charAt(0) + unit.slice(1).toLowerCase()}s</option>`).join('');
                    
                    valueInputs = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <input type="number" data-metric="${t.metric_name}" name="good_value" class="w-24 p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${goodValue}">
                                <select name="good_unit" class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">${unitOptions}</select>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center space-x-2">
                                <input type="number" data-metric="${t.metric_name}" name="ok_value" class="w-24 p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="${okValue}">
                                <select name="ok_unit" class="w-full p-2 border rounded-md bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">${unitOptions.replace(`value="${goodUnit}" selected`, `value="${goodUnit}"`).replace(`value="${okUnit}"`, `value="${okUnit}" selected`)}</select>
                            </div>
                        </td>`;
                     row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900 dark:text-white">${t.metric_name.replace(/_/g, ' ').replace('percent', '(%)')}</td>
                        ${valueInputs}
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="good_color" class="w-full h-10 p-1 border rounded-md" value="${t.good_color}"></td>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="ok_color" class="w-full h-10 p-1 border rounded-md" value="${t.ok_color}"></td>
                        <td class="px-6 py-4 whitespace-nowrap"><input type="color" data-metric="${t.metric_name}" name="bad_color" class="w-full h-10 p-1 border rounded-md" value="${t.bad_color}"></td>
                    `;
                    timeTbody.appendChild(row);
                }
            });
            container.appendChild(timeTable);
            container.appendChild(percentTable);
        };

        const handleThresholdFormSubmit = async () => {
            const tenantId = tenantSelectForConfig.value;
            if (!tenantId) return;

            const container = document.getElementById('threshold-config-forms');
            const tables = container.querySelectorAll('table');
            const timeUnits = { SECOND: 1, MINUTE: 60, HOUR: 3600, DAY: 86400 };
            
            const payload = { thresholds: [] };

            tables.forEach(table => {
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const metricName = row.dataset.metricName;
                    const goodValueEl = row.querySelector(`[data-metric="${metricName}"][name="good_value"]`);
                    const okValueEl = row.querySelector(`[data-metric="${metricName}"][name="ok_value"]`);
                    
                    let goodThreshold, okThreshold;

                    const goodUnitEl = row.querySelector(`[data-metric="${metricName}"][name="good_unit"]`);
                    const okUnitEl = row.querySelector(`[data-metric="${metricName}"][name="ok_unit"]`);

                    if (goodUnitEl && okUnitEl) {
                        const goodUnit = goodUnitEl.value;
                        const okUnit = okUnitEl.value;
                        goodThreshold = parseInt(goodValueEl.value) * timeUnits[goodUnit];
                        okThreshold = parseInt(okValueEl.value) * timeUnits[okUnit];
                    } else {
                        goodThreshold = parseInt(goodValueEl.value);
                        okThreshold = parseInt(okValueEl.value);
                    }

                    payload.thresholds.push({
                        metric_name: metricName,
                        good_threshold: goodThreshold,
                        ok_threshold: okThreshold,
                        good_color: row.querySelector(`[data-metric="${metricName}"][name="good_color"]`).value,
                        ok_color: row.querySelector(`[data-metric="${metricName}"][name="ok_color"]`).value,
                        bad_color: row.querySelector(`[data-metric="${metricName}"][name="bad_color"]`).value,
                    });
                });
            });

            try {
                const response = await fetch(`${API_BASE_URL}/tenants/${tenantId}/thresholds`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Failed to save thresholds');
                showToast('Thresholds saved successfully!');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        };

        const handleRevertThresholds = async () => {
            const tenantId = tenantSelectForConfig.value;
            if (!tenantId) {
                showToast('Please select a tenant first.', 'danger');
                return;
            }

            const confirmed = await showModal('Are you sure you want to revert all thresholds to their default values? Any custom changes will be lost.');
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE_URL}/tenants/${tenantId}/thresholds/revert`, {
                    method: 'POST',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to revert thresholds');
                }
                const newThresholds = await response.json();
                renderThresholdsForm(newThresholds); // Re-render the form with the new data
                showToast('Thresholds have been reverted to the default values.', 'success');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        };

        const handleMetricsFormSubmit = async () => {
            const mttcForm = document.getElementById('mttc-config-form');
            const mttrForm = document.getElementById('mttr-config-form');

            const mttcConfigId = mttcForm.querySelector('input[type=hidden]').value;
            const mttcConfigData = {
                config_key: "case_history_stage",
                config_value: mttcForm.querySelector('#mttc-config-value').value
            };

            const mttrConfigId = mttrForm.querySelector('input[type=hidden]').value;
            const mttrConfigData = {
                config_key: mttrForm.querySelector('#mttr-config-key').value,
                config_value: mttrForm.querySelector('#mttr-config-value').value
            };

            try {
                const responses = await Promise.all([
                    fetch(`${API_BASE_URL}/mttx-configs/${mttcConfigId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(mttcConfigData)
                    }),
                    fetch(`${API_BASE_URL}/mttx-configs/${mttrConfigId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(mttrConfigData)
                    })
                ]);

                for (const response of responses) {
                    if (!response.ok) {
                        throw new Error(`Failed to save one or more metric configurations. Status: ${response.status}`);
                    }
                }
                showToast('Metric definitions saved successfully!', 'success');
            } catch (error) {
                showToast(`Error: ${error.message}`, 'danger');
            }
        };

        const handleQueriesFormSubmit = async () => {
            const historyForm = document.getElementById('query-history-form');
            const caseForm = document.getElementById('query-case-form');

            const historyQueryId = historyForm.querySelector('input[type=hidden]').value;
            const historyQueryText = historyForm.querySelector('textarea').value;

            const caseQueryId = caseForm.querySelector('input[type=hidden]').value;
            const caseQueryText = caseForm.querySelector('textarea').value;

            try {
                const responses = await Promise.all([
                    fetch(`${API_BASE_URL}/queries/${historyQueryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query_text: historyQueryText })
                    }),
                    fetch(`${API_BASE_URL}/queries/${caseQueryId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query_text: caseQueryText })
                    })
                ]);

                for (const response of responses) {
                    if (!response.ok) {
                        throw new Error(`Failed to save one or more queries. Status: ${response.status}`);
                    }
                }
                showToast('Queries saved successfully!', 'success');
            } catch (error) {
                showToast(`Error saving queries: ${error.message}`, 'danger');
            }
        };

        // --- Analysis and Calculation Logic ---
        const loadCachedResults = (tenantId) => {
            const cachedData = localStorage.getItem(`mttx_last_run_${tenantId}`);
            const resultsContainer = document.getElementById('mttx-results-container');
            if (cachedData) {
                try {
                    const metricsData = JSON.parse(cachedData);
                    storeAndRenderInitialResults(metricsData);
                } catch (e) {
                    console.error("Failed to parse cached MTTx data", e);
                    localStorage.removeItem(`mttx_last_run_${tenantId}`);
                    resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Could not load cached results. Please run analysis again.</p>';
                    document.getElementById('show-filters-modal-btn').classList.add('hidden');
                }
            } else {
                resultsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No cached results found for this tenant. Please run an analysis.</p>';
                document.getElementById('show-filters-modal-btn').classList.add('hidden');
                fullMetricsData = null; // Clear global state if no cache
            }
        };

        const handleRunAnalysis = async () => {
            const runBtn = document.getElementById('run-analysis-btn');
            runBtn.textContent = 'Generating...';
            runBtn.disabled = true;

            const analysisParams = {
                tenant_id: parseInt(tenantSelectForAnalysis.value),
                time_unit: document.getElementById('time-unit').value,
                start_time_val: parseInt(document.getElementById('start-time-val').value)
            };

            try {
                // Step 1: Run Analysis (fetch raw data)
                const analysisResponse = await fetch(`${API_BASE_URL}/analysis/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(analysisParams)
                });
                const analysisData = await analysisResponse.json();
                if (!analysisResponse.ok) throw new Error(analysisData.detail || 'Analysis failed.');

                // Prepare for Step 2: Calculate Metrics
                const calculationPayload = {
                    tenant_id: parseInt(tenantSelectForAnalysis.value),
                    case_history_data: analysisData.case_history_data,
                    case_mttd_data: analysisData.case_mttd_data,
                    history_limit_hit: analysisData.history_limit_hit,
                    mttd_limit_hit: analysisData.mttd_limit_hit
                };

                // Step 2: Calculate Metrics
                const metricsResponse = await fetch(`${API_BASE_URL}/analysis/calculate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(calculationPayload)
                });
                if (!metricsResponse.ok) throw new Error((await metricsResponse.json()).detail || 'Calculation failed.');
                
                const metricsData = await metricsResponse.json();

                // Store the successful run in localStorage
                localStorage.setItem(`mttx_last_run_${analysisParams.tenant_id}`, JSON.stringify(metricsData));

                // Step 3: Render results and switch tab
                storeAndRenderInitialResults(metricsData);
                switchMainTab('results-panel');

            } catch (error) {
                showToast(`An error occurred:\n\n${error.message}`, 'danger');
            } finally {
                runBtn.textContent = 'Generate Report';
                runBtn.disabled = false;
            }
        };

        const formatSeconds = (seconds) => {
            if (typeof seconds !== 'number' || isNaN(seconds)) return seconds;
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            const s = Math.floor(seconds % 60);
            return `${d}d ${h}h ${m}m ${s}s`;
        };
        
        const recalculateAndRenderMetrics = (filteredCases) => {
            const caseIds = Object.keys(filteredCases);
            const totalCases = caseIds.length;

            const getValues = (metric) => caseIds.map(id => filteredCases[id][metric]).filter(v => v !== '-' && typeof v === 'number');
            const mttdValues = getValues('MTTD');
            const mttaValues = getValues('MTTA');
            const mttcValues = getValues('MTTC');
            const mttrValues = getValues('MTTR');

            const avg = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
            const completion = (arr) => totalCases > 0 ? (arr.length / totalCases) * 100 : 0;

            const metrics = {
                average_metrics: {
                    Average_MTTD_seconds: avg(mttdValues),
                    Average_MTTA_seconds: avg(mttaValues),
                    Average_MTTC_seconds: avg(mttcValues),
                    Average_MTTR_seconds: avg(mttrValues),
                },
                completion_rates: {
                    MTTD_completion_percent: completion(mttdValues).toFixed(2),
                    MTTA_completion_percent: completion(mttaValues).toFixed(2),
                    MTTC_completion_percent: completion(mttcValues).toFixed(2),
                    MTTR_completion_percent: completion(mttrValues).toFixed(2),
                    total_cases: totalCases
                },
                individual_cases: filteredCases,
                thresholds: fullMetricsData.thresholds,
                history_limit_hit: fullMetricsData.history_limit_hit,
                mttd_limit_hit: fullMetricsData.mttd_limit_hit
            };
            
            renderMttxResults(metrics);
        };
        
        const renderMttxResults = (metrics) => {
            const mttxResultsContainer = document.getElementById('mttx-results-container');
            const showDetails = showDetailsState;
            const selectedUnit = selectedUnitState;

            mttxResultsContainer.innerHTML = '';

            if (metrics.history_limit_hit || metrics.mttd_limit_hit) {
                let warningMessage = '<strong>Warning:</strong> The query result limit (1000 rows) was reached for ';
                const hit_limits = [];
                if (metrics.history_limit_hit) hit_limits.push('Case History data');
                if (metrics.mttd_limit_hit) hit_limits.push('Case MTTD data');
                warningMessage += hit_limits.join(' and ') + '. The report may be incomplete. Please select a smaller time range for a complete analysis.';
                const warningDiv = document.createElement('div');
                warningDiv.innerHTML = `<div class="p-4 mb-4 text-sm text-yellow-800 rounded-lg bg-yellow-50 dark:bg-gray-800 dark:text-yellow-300" role="alert">${warningMessage}</div>`;
                mttxResultsContainer.appendChild(warningDiv);
            }

            const getTimeThresholdColor = (metricName, valueInSeconds) => {
                const threshold = metrics.thresholds.find(t => t.metric_name === metricName);
                if (!threshold || typeof valueInSeconds !== 'number') return 'transparent';
                if (valueInSeconds <= threshold.good_threshold) return threshold.good_color;
                if (valueInSeconds <= threshold.ok_threshold) return threshold.ok_color;
                return threshold.bad_color;
            };
            
            const getCompletionThresholdColor = (metricName, valuePercent) => {
                const threshold = metrics.thresholds.find(t => t.metric_name === metricName);
                if (!threshold || typeof valuePercent !== 'number') return 'bg-gray-100';
                if (valuePercent >= threshold.good_threshold) return threshold.good_color;
                if (valuePercent >= threshold.ok_threshold) return threshold.ok_color;
                return threshold.bad_color;
            };

            const createMetricCard = (title, data, thresholds) => {
                const card = document.createElement('div');
                card.className = 'card p-6 mb-8';
                let header = `<h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">${title}</h2>`;
                if(data.total_cases !== undefined) {
                    header += `<p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Based on a total of <strong>${data.total_cases}</strong> cases.</p>`;
                }
                card.innerHTML = header;
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-center';
                data.items.forEach(item => {
                    const colorStyle = item.color ? `style="background-color: ${item.color}"` : '';
                    
                    const threshold = thresholds.find(t => t.metric_name === item.threshold_key);
                    let thresholdText = '';
                    if (threshold) {
                        const goodOperator = item.is_percent ? '' : '';
                        const okOperator = item.is_percent ? '' : '';
                        const good = item.is_percent ? `${threshold.good_threshold}%` : formatSeconds(threshold.good_threshold);
                        const ok = item.is_percent ? `${threshold.ok_threshold}%` : formatSeconds(threshold.ok_threshold);
                        thresholdText = `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Good: ${goodOperator}${good} | Ok: ${okOperator}${ok}</div>`;
                    }

                    grid.innerHTML += `<div class="p-4 rounded-lg" ${colorStyle}><div class="text-sm text-gray-600">${item.label}</div><div class="text-2xl font-bold text-gray-900">${item.value}</div>${thresholdText}</div>`;
                });
                card.appendChild(grid);
                return card;
            };

            const avgMetrics = metrics.average_metrics;
            const avgData = {
                items: [
                    { label: 'Avg. MTTD', value: formatSeconds(avgMetrics.Average_MTTD_seconds), color: getTimeThresholdColor('MTTD', avgMetrics.Average_MTTD_seconds), threshold_key: 'MTTD' },
                    { label: 'Avg. MTTA', value: formatSeconds(avgMetrics.Average_MTTA_seconds), color: getTimeThresholdColor('MTTA', avgMetrics.Average_MTTA_seconds), threshold_key: 'MTTA' },
                    { label: 'Avg. MTTC', value: formatSeconds(avgMetrics.Average_MTTC_seconds), color: getTimeThresholdColor('MTTC', avgMetrics.Average_MTTC_seconds), threshold_key: 'MTTC' },
                    { label: 'Avg. MTTR', value: formatSeconds(avgMetrics.Average_MTTR_seconds), color: getTimeThresholdColor('MTTR', avgMetrics.Average_MTTR_seconds), threshold_key: 'MTTR' }
                ]
            };
            mttxResultsContainer.appendChild(createMetricCard('Average Metrics (Efficiency)', avgData, metrics.thresholds));

            const completionRates = metrics.completion_rates;
            const completionData = {
                total_cases: completionRates.total_cases,
                items: [
                    { label: 'MTTD Completion', value: `${completionRates.MTTD_completion_percent}%`, color: getCompletionThresholdColor('MTTD_completion_percent', parseFloat(completionRates.MTTD_completion_percent)), threshold_key: 'MTTD_completion_percent', is_percent: true },
                    { label: 'MTTA Completion', value: `${completionRates.MTTA_completion_percent}%`, color: getCompletionThresholdColor('MTTA_completion_percent', parseFloat(completionRates.MTTA_completion_percent)), threshold_key: 'MTTA_completion_percent', is_percent: true },
                    { label: 'MTTC Completion', value: `${completionRates.MTTC_completion_percent}%`, color: getCompletionThresholdColor('MTTC_completion_percent', parseFloat(completionRates.MTTC_completion_percent)), threshold_key: 'MTTC_completion_percent', is_percent: true },
                    { label: 'MTTR Completion', value: `${completionRates.MTTR_completion_percent}%`, color: getCompletionThresholdColor('MTTR_completion_percent', parseFloat(completionRates.MTTR_completion_percent)), threshold_key: 'MTTR_completion_percent', is_percent: true }
                ]
            };
            mttxResultsContainer.appendChild(createMetricCard('Completion Rates (Process Adherence)', completionData, metrics.thresholds));

            const individualCases = metrics.individual_cases;
            const casesCard = document.createElement('div');
            casesCard.className = 'card p-6';
            const numCases = Object.keys(individualCases).length;
            const totalNumCases = Object.keys(fullMetricsData.individual_cases).length;
            
            const activeFiltersContainer = document.createElement('div');
            activeFiltersContainer.id = 'active-filters-display';
            activeFiltersContainer.className = 'mb-4';

            casesCard.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2 mb-4 dark:border-gray-600">
                     <h2 class="text-2xl font-bold dark:text-white">Individual Case Metrics <span class="text-lg font-normal text-gray-500 dark:text-gray-400">(${numCases} of ${totalNumCases} cases shown)</span></h2>
                     <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label for="time-unit-select" class="text-sm font-medium text-gray-700 mr-2 dark:text-gray-300">Unit</label>
                            <select id="time-unit-select" class="p-1 border rounded-md text-sm bg-white text-gray-900 border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="SECONDS">Seconds</option>
                                <option value="MINUTES">Minutes</option>
                                <option value="HOURS">Hours</option>
                                <option value="DAYS">Days</option>
                            </select>
                        </div>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="show-details-checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500" ${showDetails ? 'checked' : ''}>
                            <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Show Details</span>
                        </label>
                     </div>
                </div>`;
            casesCard.appendChild(activeFiltersContainer);
            casesCard.innerHTML += `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 table-fixed">
                        <thead id="individual-cases-thead" class="bg-gray-50 dark:bg-gray-800"></thead>
                        <tbody id="individual-cases-tbody" class="bg-white divide-y divide-gray-200 dark:bg-gray-900 dark:divide-gray-700"></tbody>
                    </table>
                </div>`;
            mttxResultsContainer.appendChild(casesCard);

            const thead = casesCard.querySelector('#individual-cases-thead');
            
            const sortableHeader = (key, label, extraClasses = '') => {
                let icon = '';
                if (sortColumn === key) {
                    icon = sortDirection === 'asc' ? ' ' : ' ';
                }
                return `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer dark:text-gray-300 ${extraClasses}" data-sort="${key}">${label}${icon}</th>`;
            };

            const unitLabel = {
                SECONDS: 'sec',
                MINUTES: 'min',
                HOURS: 'hr',
                DAYS: 'day'
            }[selectedUnit] || 'sec';

            let headerHtml = `<tr>
                ${sortableHeader('case_id', 'Case ID', 'w-1/6')}
                ${sortableHeader('MTTD', `MTTD (${unitLabel})`, 'w-1/12')}
                ${sortableHeader('MTTA', `MTTA (${unitLabel})`, 'w-1/12')}
                ${sortableHeader('MTTC', `MTTC (${unitLabel})`, 'w-1/12')}
                ${sortableHeader('MTTR', `MTTR (${unitLabel})`, 'w-1/12')}`;
            if (showDetails) {
                headerHtml += `
                    ${sortableHeader('environment', 'Environment', 'w-1/6')}
                    ${sortableHeader('detection_rule_name', 'Detection Rule', 'w-1/4')}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3 dark:text-gray-300">Tags</th>`;
            }
            headerHtml += `</tr>`;
            thead.innerHTML = headerHtml;

            thead.querySelectorAll('[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const newSortColumn = th.dataset.sort;
                    if (sortColumn === newSortColumn) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = newSortColumn;
                        sortDirection = 'asc';
                    }
                    applyFiltersAndRedraw();
                });
            });

            const tbody = casesCard.querySelector('#individual-cases-tbody');
            if(Object.keys(individualCases).length === 0) {
                 tbody.innerHTML = `<tr><td colspan="${showDetails ? 8 : 5}" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">No cases match the current filter.</td></tr>`;
            } else {
                tbody.innerHTML = '';
                
                let sortedCases = Object.values(individualCases);
                if (sortColumn) {
                    sortedCases.sort((a, b) => {
                        let valA = a[sortColumn];
                        let valB = b[sortColumn];

                        if (['MTTD', 'MTTA', 'MTTC', 'MTTR'].includes(sortColumn)) {
                            valA = (valA === '-') ? -Infinity : parseFloat(valA);
                            valB = (valB === '-') ? -Infinity : parseFloat(valB);
                        } else {
                            valA = String(valA || '').toLowerCase();
                            valB = String(valB || '').toLowerCase();
                        }

                        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                        return 0;
                    });
                }

                const convertSeconds = (seconds, unit) => {
                    if (typeof seconds !== 'number' || isNaN(seconds)) return seconds;
                    switch (unit) {
                        case 'MINUTES': return (seconds / 60).toFixed(2);
                        case 'HOURS': return (seconds / 3600).toFixed(2);
                        case 'DAYS': return (seconds / 86400).toFixed(2);
                        case 'SECONDS':
                        default:
                            return seconds;
                    }
                };

                for (const caseMetrics of sortedCases) {
                    const caseId = caseMetrics.case_id;
                    const mttdColor = getTimeThresholdColor('MTTD', caseMetrics.MTTD);
                    const mttaColor = getTimeThresholdColor('MTTA', caseMetrics.MTTA);
                    const mttcColor = getTimeThresholdColor('MTTC', caseMetrics.MTTC);
                    const mttrColor = getTimeThresholdColor('MTTR', caseMetrics.MTTR);

                    let rowHtml = `
                        <tr class="dark:bg-gray-800 dark:border-gray-700">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${caseMetrics.link ? `<a href="${caseMetrics.link}" target="_blank" class="text-blue-600 hover:underline dark:text-blue-400">${caseId}</a>` : caseId}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" style="background-color: ${mttdColor};">${convertSeconds(caseMetrics.MTTD, selectedUnit)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" style="background-color: ${mttaColor};">${convertSeconds(caseMetrics.MTTA, selectedUnit)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" style="background-color: ${mttcColor};">${convertSeconds(caseMetrics.MTTC, selectedUnit)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" style="background-color: ${mttrColor};">${convertSeconds(caseMetrics.MTTR, selectedUnit)}</td>`;
                    if (showDetails) {
                        const tagsHtml = (caseMetrics.tags || []).map(tag => `<span class="bg-blue-100 text-blue-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-blue-400 border border-blue-400">${tag}</span>`).join('');
                        const envHtml = caseMetrics.environment ? `<span class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-green-400 border border-green-400">${caseMetrics.environment}</span>` : '-';
                        const rules = (caseMetrics.detection_rule_name && caseMetrics.detection_rule_name !== 'Unknown') ? caseMetrics.detection_rule_name.split(', ') : [];
                        const rulesHtml = rules.map(rule => `<span class="bg-gray-100 text-gray-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-gray-400 border border-gray-500">${rule}</span>`).join(' ');
                        rowHtml += `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${envHtml}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 break-words dark:text-gray-300">${rulesHtml || '-'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300"><div class="flex flex-wrap gap-1">${tagsHtml || '-'}</div></td>`;
                    }
                    rowHtml += `</tr>`;
                    tbody.innerHTML += rowHtml;
                }
            }
            document.getElementById('show-details-checkbox').addEventListener('change', (e) => {
                showDetailsState = e.target.checked;
                applyFiltersAndRedraw();
            });
            const newTimeUnitSelect = document.getElementById('time-unit-select');
            if (newTimeUnitSelect) {
                newTimeUnitSelect.value = selectedUnit;
                newTimeUnitSelect.addEventListener('change', (e) => {
                    selectedUnitState = e.target.value;
                    applyFiltersAndRedraw();
                });
            }
        };
        
        const applyFiltersAndRedraw = () => {
            const filterMode = document.getElementById('filter-mode').value;
            const selectedTags = new Set([...document.querySelectorAll('#tag-filter-options input:checked')].map(el => el.value));
            const selectedEnvs = new Set([...document.querySelectorAll('#environment-filter-options input:checked')].map(el => el.value));
            const selectedRules = new Set([...document.querySelectorAll('#rule-filter-options input:checked')].map(el => el.value));

            const pillsContainer = document.getElementById('active-filters-pills');
            pillsContainer.innerHTML = ''; // Clear existing pills

            const createPill = (type, value) => {
                const pill = document.createElement('div');
                pill.className = 'filter-pill';
                pill.innerHTML = `<span><strong>${type}:</strong> ${value}</span>`;
                pillsContainer.appendChild(pill);
            };

            selectedEnvs.forEach(env => createPill('Env', env));
            selectedRules.forEach(rule => createPill('Rule', rule));
            selectedTags.forEach(tag => createPill('Tag', tag));
            if (selectedTags.size > 0) {
                 createPill('Tag Mode', filterMode);
            }

            const filteredCases = {};
            for (const caseId in fullMetricsData.individual_cases) {
                const caseData = fullMetricsData.individual_cases[caseId];
                const caseTags = new Set(caseData.tags || []);
                const caseEnv = caseData.environment;
                const caseRule = caseData.detection_rule_name;

                const tagMatch = selectedTags.size === 0 || (filterMode === 'include' 
                    ? [...selectedTags].some(tag => caseTags.has(tag))
                    : ![...selectedTags].some(tag => caseTags.has(tag))
                );
                
                const envMatch = selectedEnvs.size === 0 || selectedEnvs.has(caseEnv);
                const ruleMatch = selectedRules.size === 0 || selectedRules.has(caseRule);

                if (tagMatch && envMatch && ruleMatch) {
                    filteredCases[caseId] = caseData;
                }
            }
            recalculateAndRenderMetrics(filteredCases);
            if (filtersModal) {
                filtersModal.hide();
            }
        };
        
        const filterCheckboxList = (inputId, containerId) => {
            const searchInput = document.getElementById(inputId);
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const labels = document.querySelectorAll(`#${containerId} label`);
                labels.forEach(label => {
                    const text = label.textContent.toLowerCase();
                    label.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        };

        const storeAndRenderInitialResults = (metrics) => {
            document.getElementById('show-filters-modal-btn').classList.remove('hidden');
            fullMetricsData = metrics; // Store the complete, unfiltered dataset
            const baseUrl = metrics.base_url;

            Object.keys(fullMetricsData.individual_cases).forEach(caseId => {
                fullMetricsData.individual_cases[caseId].case_id = caseId;
                if (baseUrl) {
                    fullMetricsData.individual_cases[caseId].link = `${baseUrl}/cases/${caseId}`;
                }
            });

            const tagOptionsContainer = document.getElementById('tag-filter-options');
            const envOptionsContainer = document.getElementById('environment-filter-options');
            const ruleOptionsContainer = document.getElementById('rule-filter-options');
            
            const allTags = new Set();
            const allEnvs = new Set();
            const allRules = new Set();

            Object.values(metrics.individual_cases).forEach(caseData => {
                (caseData.tags || []).forEach(tag => allTags.add(tag));
                if(caseData.environment) allEnvs.add(caseData.environment);
                if(caseData.detection_rule_name) allRules.add(caseData.detection_rule_name);
            });

            const createCheckboxes = (container, items) => {
                container.innerHTML = '';
                if(items.size > 0){
                    items.forEach(item => {
                        container.innerHTML += `
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" value="${item}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:bg-gray-600 dark:border-gray-500">
                                <span class="text-sm text-gray-700 dark:text-gray-300">${item}</span>
                            </label>
                        `;
                    });
                } else {
                    container.innerHTML = `<span class="text-sm text-gray-500 dark:text-gray-400">None found.</span>`;
                }
            };

            createCheckboxes(tagOptionsContainer, allTags);
            createCheckboxes(envOptionsContainer, allEnvs);
            createCheckboxes(ruleOptionsContainer, allRules);

            recalculateAndRenderMetrics(fullMetricsData.individual_cases);
        };

        const handleCalculateMetrics = async () => {
            const calcBtn = document.getElementById('calculate-metrics-btn');
            calcBtn.textContent = 'Calculating...';
            calcBtn.disabled = true;

            const payload = { 
                tenant_id: parseInt(tenantSelectForAnalysis.value), 
                case_history_data: caseHistoryData,
                case_mttd_data: caseMttdData
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/analysis/calculate`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error((await response.json()).detail || 'Calculation failed.');
                storeAndRenderInitialResults(await response.json());
                switchMainTab('results-panel');
            } catch (error) {
                console.error("Calculation API Error:", error);
                showToast(`An error occurred during calculation:\n\n${error.message}`, 'danger');
            } finally {
                calcBtn.textContent = 'Calculate MTTx Metrics';
                calcBtn.disabled = false;
            }
        };
        
        const populateSignalNoiseSelectors = () => {
            const signalSelect = document.getElementById('signal-tags-select');
            const noiseSelect = document.getElementById('noise-tags-select');
            
            const allTags = new Set();
            if (fullMetricsData && fullMetricsData.individual_cases) {
                 Object.values(fullMetricsData.individual_cases).forEach(caseData => {
                    (caseData.tags || []).forEach(tag => allTags.add(tag));
                });
            }

            signalSelect.innerHTML = '';
            noiseSelect.innerHTML = '';
            allTags.forEach(tag => {
                const option = new Option(tag, tag);
                signalSelect.add(option.cloneNode(true));
                noiseSelect.add(option);
            });
        };
        
        const generateQuadrantChart = () => {
            const signalTags = new Set([...document.getElementById('signal-tags-select').selectedOptions].map(o => o.value));
            const noiseTags = new Set([...document.getElementById('noise-tags-select').selectedOptions].map(o => o.value));

            const ruleData = {};
             const filteredCases = getFilteredCases();

            Object.values(filteredCases).forEach(caseData => {
                const rule = caseData.detection_rule_name || 'Unknown Rule';
                if (!ruleData[rule]) {
                    ruleData[rule] = { signal: 0, noise: 0, volume: 0 };
                }
                const tags = new Set(caseData.tags || []);
                ruleData[rule].volume++;
                if ([...signalTags].some(tag => tags.has(tag))) ruleData[rule].signal++;
                if ([...noiseTags].some(tag => tags.has(tag))) ruleData[rule].noise++;
            });
            
            const datasets = [{
                label: 'Detection Rules',
                data: Object.entries(ruleData).map(([ruleName, counts]) => ({
                    x: counts.noise,
                    y: counts.signal,
                    r: Math.max(5, Math.sqrt(counts.volume) * 5), // Bubble radius
                    ruleName: ruleName
                })),
                backgroundColor: 'rgba(59, 130, 246, 0.7)'
            }];

            if (signalChart) signalChart.destroy();
            
            signalChart = new Chart(document.getElementById('signal-chart').getContext('2d'), {
                type: 'bubble',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Signal Count' }, beginAtZero: true },
                        x: { title: { display: true, text: 'Noise Count' }, beginAtZero: true }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const d = context.raw;
                                    return `${d.ruleName}: (Noise: ${d.x}, Signal: ${d.y}, Volume: ${Math.round(Math.pow(d.r/5, 2))})`;
                                }
                            }
                        }
                    }
                }
            });
        };
        
        const getFilteredCases = () => {
             if (!fullMetricsData) return {};
             const filterMode = document.getElementById('filter-mode').value;
            const selectedTags = new Set([...document.querySelectorAll('#tag-filter-options input:checked')].map(el => el.value));
            const selectedEnvs = new Set([...document.querySelectorAll('#environment-filter-options input:checked')].map(el => el.value));
            const selectedRules = new Set([...document.querySelectorAll('#rule-filter-options input:checked')].map(el => el.value));

            if (selectedTags.size === 0 && selectedEnvs.size === 0 && selectedRules.size === 0) {
                return fullMetricsData.individual_cases;
            }

            const filteredCases = {};
            for (const caseId in fullMetricsData.individual_cases) {
                const caseData = fullMetricsData.individual_cases[caseId];
                const caseTags = new Set(caseData.tags || []);
                const caseEnv = caseData.environment;
                const caseRule = caseData.detection_rule_name;

                const tagMatch = selectedTags.size === 0 || (filterMode === 'include' 
                    ? [...selectedTags].some(tag => caseTags.has(tag))
                    : ![...selectedTags].some(tag => caseTags.has(tag))
                );
                
                const envMatch = selectedEnvs.size === 0 || selectedEnvs.has(caseEnv);
                const ruleMatch = selectedRules.size === 0 || selectedRules.has(caseRule);

                if (tagMatch && envMatch && ruleMatch) {
                    filteredCases[caseId] = caseData;
                }
            }
            return filteredCases;
        }

        const initAccordions = () => {
            document.querySelectorAll('[data-accordion]').forEach(accordionEl => {
                new Accordion(accordionEl);
            });
        };


        // --- Theme Toggler ---
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        // Change the icons inside the button based on previous settings
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            themeToggleLightIcon.classList.remove('hidden');
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
        }

        const themeToggleBtn = document.getElementById('theme-toggle');

        themeToggleBtn.addEventListener('click', function() {
            // toggle icons inside button
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            // if set via local storage previously
            if (localStorage.getItem('color-theme')) {
                if (localStorage.getItem('color-theme') === 'light') {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                }
            // if NOT set via local storage previously
            } else {
                if (document.documentElement.classList.contains('dark')) {
                    document.documentElement.classList.remove('dark');
                    localStorage.setItem('color-theme', 'light');
                } else {
                    document.documentElement.classList.add('dark');
                    localStorage.setItem('color-theme', 'dark');
                }
            }
        });


        // --- Event Listeners & Init ---
        document.addEventListener('DOMContentLoaded', () => {
            switchMainTab('tenants-panel');
            fetchVersion();
            fetchTenants().then(() => {
                const selectedTenantId = tenantSelectForAnalysis.value;
                if (selectedTenantId) {
                    loadCachedResults(selectedTenantId);
                }
            });
            initAccordions();
            filtersModal = new Modal(document.getElementById('filters-modal'));
            defaultModal = new Modal(document.getElementById('default-modal'));

            document.getElementById('show-filters-modal-btn').addEventListener('click', () => {
                if (fullMetricsData) {
                    filtersModal.show();
                } else {
                    alert('Please run an analysis first to generate data for filtering.');
                }
            });

            tenantSelectForAnalysis.addEventListener('change', e => loadCachedResults(e.target.value));
            tenantSelectForConfig.addEventListener('change', (e) => loadAndDisplayConfigs(e.target.value));
            tenantSelectForScheduler.addEventListener('change', (e) => loadAndDisplaySchedules(e.target.value));
            document.getElementById('mttr-config-key').addEventListener('change', updateMttrValueOptions);
            
            document.getElementById('save-metrics-btn').addEventListener('click', handleMetricsFormSubmit);
            document.getElementById('save-queries-btn').addEventListener('click', handleQueriesFormSubmit);
            document.getElementById('save-thresholds-btn').addEventListener('click', handleThresholdFormSubmit);

            document.getElementById('run-analysis-btn').addEventListener('click', handleRunAnalysis);
            document.getElementById('apply-filters-btn').addEventListener('click', applyFiltersAndRedraw);
        document.getElementById('save-metrics-btn').addEventListener('click', handleMetricsFormSubmit);
        document.getElementById('save-queries-btn').addEventListener('click', handleQueriesFormSubmit);
        document.getElementById('run-analysis-btn').addEventListener('click', handleRunAnalysis);
        document.getElementById('show-filters-modal-btn').addEventListener('click', () => filtersModal.show());
        document.getElementById('apply-filters-btn').addEventListener('click', applyFiltersAndRedraw);
        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.querySelectorAll('#filter-body input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('#filter-body input[type="text"]').forEach(input => input.value = '');
            applyFiltersAndRedraw();
        });
        document.getElementById('generate-chart-btn').addEventListener('click', generateQuadrantChart);
        document.getElementById('toggle-filter-lists-btn').addEventListener('click', (e) => {
            const lists = document.querySelectorAll('.filter-options-list');
            const isCollapsed = e.target.textContent.includes('Expand');
            lists.forEach(list => list.classList.toggle('collapsed', !isCollapsed));
            e.target.textContent = isCollapsed ? 'Collapse All Lists' : 'Expand All Lists';
        });
        document.getElementById('revert-thresholds-btn').addEventListener('click', handleRevertThresholds);
            
            filterCheckboxList('tag-search', 'tag-filter-options');
            filterCheckboxList('environment-search', 'environment-filter-options');
            filterCheckboxList('rule-search', 'rule-filter-options');
            
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.querySelectorAll('#tag-filter-options input:checked, #environment-filter-options input:checked, #rule-filter-options input:checked').forEach(el => el.checked = false);
                document.getElementById('tag-search').value = '';
                document.getElementById('environment-search').value = '';
                document.getElementById('rule-search').value = '';
                document.getElementById('active-filters-pills').innerHTML = '';
                filterCheckboxList('tag-search', 'tag-filter-options');
                filterCheckboxList('environment-search', 'environment-filter-options');
                filterCheckboxList('rule-search', 'rule-filter-options');
                applyFiltersAndRedraw();
            });

            document.getElementById('add-tenant-btn').addEventListener('click', () => showTenantModal());
            document.getElementById('create-schedule-btn').addEventListener('click', () => showScheduleModal());

            addTenantForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const tenantData = {
                    name: document.getElementById('tenant-name').value,
                    guid: document.getElementById('tenant-guid').value,
                    gcp_project_id: document.getElementById('tenant-gcp-project').value,
                    region: document.getElementById('tenant-region').value,
                    base_url: document.getElementById('base-url').value,
                    soar_url: document.getElementById('soar-url').value,
                    soar_api_key: document.getElementById('soar-api-key').value,
                };
                const tenantId = document.getElementById('tenant-id').value;
                const url = tenantId ? `${API_BASE_URL}/tenants/${tenantId}` : `${API_BASE_URL}/tenants`;
                const method = tenantId ? 'PUT' : 'POST';
                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(tenantData) });
                    if (!response.ok) throw new Error( (await response.json()).detail );
                    tenantModal.hide();
                    fetchTenants();
                } catch (error) {
                    alert(`Failed to ${tenantId ? 'update' : 'add'} tenant: ${error.message}`);
                }
            });

            const toggleBtn = document.getElementById('toggle-filter-lists-btn');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    const lists = document.querySelectorAll('.filter-options-list');
                    if (lists.length === 0) return;
                    
                    // Check the state of the first list
                    const isCollapsed = lists[0].classList.contains('collapsed');
                    
                    // Toggle all lists based on the state of the first one
                    lists.forEach(list => {
                        list.classList.toggle('collapsed', !isCollapsed);
                    });
                    toggleBtn.textContent = isCollapsed ? 'Collapse All Lists' : 'Expand All Lists';
                });
            }            
        });
    </script>

</body>
</html>

